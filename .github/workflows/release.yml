name: Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - bugfix
          - feature
          - major

env:
  CARGO_TERM_COLOR: always

jobs:
  version:
    name: Bump Version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify main branch
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "::error::Releases must be created from the main branch"
            exit 1
          fi

      - name: Calculate new version
        id: version
        run: |
          # Get latest tag or default to v0.0.0
          LATEST=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' | sort -V | tail -1 || echo "v0.0.0")
          if [ -z "$LATEST" ]; then
            LATEST="v0.0.0"
          fi

          # Parse version components
          MAJOR=$(echo "$LATEST" | sed 's/v\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\)/\1/')
          MINOR=$(echo "$LATEST" | sed 's/v\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\)/\2/')
          PATCH=$(echo "$LATEST" | sed 's/v\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\)/\3/')

          # Calculate new version based on release type
          case "${{ inputs.release_type }}" in
            major)
              NEW_VERSION="$((MAJOR+1)).0.0"
              ;;
            feature)
              NEW_VERSION="${MAJOR}.$((MINOR+1)).0"
              ;;
            bugfix)
              NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH+1))"
              ;;
          esac

          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "New version: ${NEW_VERSION}"

      - name: Update Cargo.toml version
        run: |
          sed -i 's/^version = ".*"/version = "${{ steps.version.outputs.version }}"/' Cargo.toml

      - name: Update CHANGES.md
        run: |
          DATE=$(date +%Y-%m-%d)
          VERSION="${{ steps.version.outputs.version }}"

          # Update changelog: move Unreleased content to new version section
          perl -i -0777 -pe '
            s/## Unreleased\n+(### New\n(.*?))?(\n### Changed\n(.*?))?(\n### Fixed\n(.*?))?\n+(?=##|\z)/
              "## Unreleased\n\n### New\n\n### Changed\n\n### Fixed\n\n" .
              "## '"$VERSION"' - '"$DATE"'\n" .
              ($2 ? "\n### New\n$2" : "") .
              ($4 ? "\n### Changed\n$4" : "") .
              ($6 ? "\n### Fixed\n$6" : "") .
              "\n"
            /se' CHANGES.md

      - name: Commit and tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Cargo.toml CHANGES.md
          git commit -m "Release ${{ steps.version.outputs.tag }}"
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"
          git push origin main --tags

  build-binaries:
    name: Build ${{ matrix.target }}
    needs: version
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            archive: tar.gz
            cross: true
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            archive: tar.gz
            cross: true
          - target: x86_64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: aarch64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.version.outputs.tag }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross (Linux ARM64)
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build binary
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            RUSTFLAGS="-C target-feature=+crt-static" cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
        shell: bash

      - name: Create archive (Unix)
        if: matrix.archive == 'tar.gz'
        run: |
          mkdir -p dist
          BINARY="target/${{ matrix.target }}/release/byonk"
          ARCHIVE="byonk-${{ needs.version.outputs.version }}-${{ matrix.target }}.tar.gz"

          # Create staging directory
          mkdir -p staging/byonk
          cp "$BINARY" staging/byonk/
          cp -r fonts staging/byonk/ 2>/dev/null || true
          cp -r screens staging/byonk/ 2>/dev/null || true
          cp config.yaml staging/byonk/ 2>/dev/null || true
          cp README.md staging/byonk/
          cp LICENSE staging/byonk/

          tar -czvf "dist/${ARCHIVE}" -C staging byonk
          echo "ARCHIVE=${ARCHIVE}" >> $GITHUB_ENV
        shell: bash

      - name: Create archive (Windows)
        if: matrix.archive == 'zip'
        run: |
          mkdir dist
          $BINARY = "target/${{ matrix.target }}/release/byonk.exe"
          $ARCHIVE = "byonk-${{ needs.version.outputs.version }}-${{ matrix.target }}.zip"

          # Create staging directory
          mkdir staging/byonk
          Copy-Item $BINARY staging/byonk/
          Copy-Item -Recurse fonts staging/byonk/ -ErrorAction SilentlyContinue
          Copy-Item -Recurse screens staging/byonk/ -ErrorAction SilentlyContinue
          Copy-Item config.yaml staging/byonk/ -ErrorAction SilentlyContinue
          Copy-Item README.md staging/byonk/
          Copy-Item LICENSE staging/byonk/

          Compress-Archive -Path staging/byonk -DestinationPath "dist/$ARCHIVE"
          echo "ARCHIVE=$ARCHIVE" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: byonk-${{ matrix.target }}
          path: dist/*

  build-container:
    name: Build Container
    needs: [version, build-binaries]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.version.outputs.tag }}

      - name: Download Linux AMD64 binary
        uses: actions/download-artifact@v4
        with:
          name: byonk-x86_64-unknown-linux-musl
          path: artifacts/amd64

      - name: Download Linux ARM64 binary
        uses: actions/download-artifact@v4
        with:
          name: byonk-aarch64-unknown-linux-musl
          path: artifacts/arm64

      - name: Extract binaries
        run: |
          mkdir -p binaries/amd64 binaries/arm64
          tar -xzf artifacts/amd64/byonk-*-x86_64-unknown-linux-musl.tar.gz -C binaries/amd64 --strip-components=1
          tar -xzf artifacts/arm64/byonk-*-aarch64-unknown-linux-musl.tar.gz -C binaries/arm64 --strip-components=1

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate version tags
        id: tags
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f1-2)
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.release
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ needs.version.outputs.version }}
            ghcr.io/${{ github.repository }}:${{ steps.tags.outputs.minor }}
            ghcr.io/${{ github.repository }}:${{ steps.tags.outputs.major }}
          build-args: |
            BINARY_DIR=binaries

  create-release:
    name: Create GitHub Release
    needs: [version, build-binaries, build-container]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.version.outputs.tag }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Extract release notes
        id: changelog
        run: |
          # Extract the changelog section for this version
          VERSION="${{ needs.version.outputs.version }}"
          NOTES=$(sed -n "/^## ${VERSION}/,/^## [0-9]/p" CHANGES.md | sed '$d')

          # Write to file for the release
          echo "$NOTES" > release-notes.md

          # Also output for debugging
          echo "Release notes:"
          cat release-notes.md

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.tag }}
          name: Byonk ${{ needs.version.outputs.tag }}
          body_path: release-notes.md
          files: artifacts/*
          fail_on_unmatched_files: true
          draft: false
          prerelease: false
