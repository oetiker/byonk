# Milestone v1.0: E-ink Color Rendering Fix

**Status:** SHIPPED 2026-02-05
**Phases:** 1-3
**Total Plans:** 3

## Overview

Fix the color perception pipeline in the `eink-dither` crate so that multi-color e-ink devices produce visually correct renders. The core bug is a missing chroma coupling penalty in the HyAB distance metric, causing grey pixels to map to chromatic palette entries. The fix is surgical (one formula in one file), followed by validation and auto-detection improvements, then documentation for maintainability.

## Phases

### Phase 1: Core Distance Metric Fix

**Goal**: Dithered output maps grey pixels to achromatic palette entries and chromatic pixels to correct chromatic entries
**Depends on**: Nothing (first phase)
**Requirements**: DIST-01, DIST-02, DIST-03, DIST-04, TEST-01, TEST-02, TEST-05
**Plans**: 1 plan

Plans:
- [x] 01-01-PLAN.md -- Add chroma coupling penalty to HyAB distance metric with tests

**Success Criteria** (what must be TRUE):
  1. A grey gradient (0-255) dithered on a BWRGBY palette produces only black and white pixels -- no color bleed
  2. Pure red, green, blue, and yellow pixels each match their exact palette entry
  3. Orange or other off-palette chromatic colors map to the nearest chromatic palette entry, not to black or white
  4. All existing crate tests continue to pass without modification

### Phase 2: Auto-Detection and Edge Cases

**Goal**: The crate automatically selects the correct distance metric and handles edge-case colors correctly
**Depends on**: Phase 1
**Requirements**: AUTO-01, AUTO-02, AUTO-03, TEST-03, TEST-04
**Plans**: 1 plan

Plans:
- [x] 02-01-PLAN.md -- Add auto-detection to Palette::new(), simplify svg_to_png.rs, add edge-case tests

**Success Criteria** (what must be TRUE):
  1. Pastel and desaturated colors (e.g., light pink, pale blue) map to their correct chromatic palette entries, not to white
  2. Edge-case colors (brown, skin tones, dark chromatic) map to the visually closest palette entry
  3. An achromatic-only palette (B/W/grey) automatically uses Euclidean distance without caller configuration
  4. A chromatic palette (BWRGBY) automatically uses HyAB+chroma without caller configuration

### Phase 3: Color Science Documentation

**Goal**: A developer reading the crate can understand why each color space conversion and distance calculation exists
**Depends on**: Phase 2
**Requirements**: DOCS-01, DOCS-02, DOCS-03
**Plans**: 1 plan

Plans:
- [x] 03-01-PLAN.md -- Add color science rationale, pipeline diagram, and inline WHY comments

**Success Criteria** (what must be TRUE):
  1. Crate-level documentation explains the HyAB + chroma coupling distance metric choice with color science rationale
  2. A pipeline diagram shows which color space is used at each stage (sRGB input, Linear RGB error diffusion, OKLab matching)
  3. Every color space conversion in the code has an inline comment explaining why that particular space is used at that point

## Progress

| Phase | Plans Complete | Status | Completed |
|-------|---------------|--------|-----------|
| 1. Core Distance Metric Fix | 1/1 | Complete | 2026-02-05 |
| 2. Auto-Detection and Edge Cases | 1/1 | Complete | 2026-02-05 |
| 3. Color Science Documentation | 1/1 | Complete | 2026-02-05 |

---

## Milestone Summary

**Key Decisions:**

- Focus on eink-dither crate only (SVG rendering is correct, problem is palette mapping)
- HyAB + chroma coupling fix -- single formula change fixes root cause
- kchroma=10.0 (was 2.0) -- blue noise dithering's find_second_nearest needed kchroma>8.2 to prevent yellow capturing grey pixels
- CHROMA_DETECTION_THRESHOLD=0.03 -- cleanly separates achromatic from chromatic palettes
- Auto-detection in Palette::new() with with_distance_metric() as override
- Chroma coupling explicitly documented as domain-specific extension, not standard HyAB

**Issues Resolved:**

- Grey pixels mapping to chromatic palette entries (yellow, blue) instead of B/W
- Manual distance metric selection required by callers
- No documentation of color science rationale

**Issues Deferred:**

- kchroma=10.0 validation on physical e-ink hardware (v2 requirement TUNE-01)
- Preprocessing parameter re-tuning (v2 requirement TUNE-02)
- Visual regression test suite (v2 requirement TUNE-03)

**Technical Debt Incurred:**

None.

---

_For current project status, see .planning/ROADMAP.md_
