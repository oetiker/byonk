---
phase: 03-color-science-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/eink-dither/src/lib.rs
  - crates/eink-dither/src/palette/palette.rs
  - crates/eink-dither/src/dither/mod.rs
  - crates/eink-dither/src/dither/blue_noise.rs
  - crates/eink-dither/src/preprocess/preprocessor.rs
  - crates/eink-dither/src/color/oklab.rs
  - crates/eink-dither/src/color/linear_rgb.rs
  - crates/eink-dither/src/color/srgb.rs
  - crates/eink-dither/src/color/lut.rs
autonomous: true

must_haves:
  truths:
    - "A developer reading lib.rs understands why three color spaces exist and what each is used for"
    - "A developer reading lib.rs can see the full pipeline flow with color spaces labeled at each stage"
    - "A developer reading lib.rs understands the HyAB + chroma coupling metric, including that the chroma coupling is a domain-specific extension (not published literature)"
    - "A developer reading any color space conversion in implementation code finds a WHY comment explaining why that specific space is used at that point"
    - "No code logic has been changed -- only comments and doc strings"
  artifacts:
    - path: "crates/eink-dither/src/lib.rs"
      provides: "Color Science section with HyAB rationale and ASCII pipeline diagram"
      contains: "# Color Science"
    - path: "crates/eink-dither/src/palette/palette.rs"
      provides: "WHY comments on palette precomputation conversions"
      contains: "WHY"
    - path: "crates/eink-dither/src/dither/mod.rs"
      provides: "WHY comments on error diffusion conversion sites"
      contains: "WHY"
    - path: "crates/eink-dither/src/dither/blue_noise.rs"
      provides: "WHY comments on blue noise matching conversions"
      contains: "WHY"
    - path: "crates/eink-dither/src/preprocess/preprocessor.rs"
      provides: "WHY comments on preprocessing conversion chain"
      contains: "WHY"
    - path: "crates/eink-dither/src/color/lut.rs"
      provides: "WHY comment explaining LUT over per-call formula"
      contains: "WHY"
  key_links:
    - from: "crates/eink-dither/src/lib.rs"
      to: "palette::DistanceMetric"
      via: "doc narrative references the metric enum"
      pattern: "HyAB.*chroma coupling"
    - from: "crates/eink-dither/src/lib.rs"
      to: "pipeline stages"
      via: "ASCII diagram labels color spaces at each stage"
      pattern: "LinearRgb.*Oklab.*find_nearest"
---

<objective>
Add comprehensive color science documentation to the eink-dither crate: a crate-level "Color Science" section in lib.rs with HyAB + chroma coupling rationale and ASCII pipeline diagram, plus inline WHY comments at every color space conversion site in implementation code.

Purpose: A future developer (or future-you) reading this crate can understand WHY each color space is used WHERE, preventing well-intentioned but incorrect "improvements" that would break perceptual accuracy.

Output: Updated documentation in 9 source files. No code logic changes.
</objective>

<execution_context>
@/Users/oetiker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/oetiker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-color-science-documentation/03-RESEARCH.md
@crates/eink-dither/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Color Science section and pipeline diagram to lib.rs</name>
  <files>crates/eink-dither/src/lib.rs</files>
  <action>
Add a `# Color Science` section to the crate-level `//!` documentation in `lib.rs`, placed AFTER the existing `# Dithering Algorithms` section and BEFORE the `pub mod` declarations. This section covers DOCS-01 (HyAB + chroma coupling rationale) and DOCS-02 (pipeline diagram).

The section must include these subsections in order:

1. **`## Three Color Spaces, Three Purposes`** -- Explain why sRGB (I/O encoding), Linear RGB (physically correct arithmetic), and OKLab (perceptual uniformity) each exist. Include a small table: `| Color Space | Property | Used For |`. Emphasize that using the wrong space at any stage produces dramatically wrong results.

2. **`## Pipeline Overview`** -- An ASCII art diagram in a ```` ```text ```` block showing the full dithering pipeline flow with color spaces labeled at each stage. Follow the diagram structure from the research (03-RESEARCH.md, Pattern 2), covering: sRGB input -> LinearRgb (gamma decode) -> optional Oklch (saturation boost) -> LinearRgb (contrast) -> dither loop in LinearRgb -> Oklab (matching) -> find_nearest (HyAB + chroma) -> palette index -> LinearRgb error -> diffuse to neighbors.

3. **`## Distance Metric: HyAB + Chroma Coupling`** -- Explain why standard Euclidean distance in OKLab fails for discrete e-ink palettes (grey pixel near yellow in lightness). Explain standard HyAB (Abasi et al., 2020) with the formula `d_HyAB = kl * |dL| + kc * sqrt(da^2 + db^2)`. Then CLEARLY STATE that chroma coupling is a domain-specific extension, NOT from published literature. Show the extended formula `d = kl * |dL| + kc * sqrt(da^2 + db^2) + kchroma * |C_pixel - C_palette|`. Document kl=2.0, kc=1.0, kchroma=10.0 and the rationale for kchroma=10.0 (blue noise dithering's find_second_nearest needs kchroma > 8.2 to prevent yellow L=0.97 from capturing grey pixels).

4. **`## Why Error Diffusion Stays in Linear RGB`** -- Explain that quantization error represents physical light difference, light adds linearly, so error must be in Linear RGB. Briefly note what goes wrong in sRGB (over-weights dark tones) and OKLab (not physically correct for light addition).

Use the example text from 03-RESEARCH.md (Example 1) as a reference but write it fresh -- do not copy-paste verbatim. Keep the tone technical but accessible. Use backtick-formatted code for formulas (NOT LaTeX). Use `[`DistanceMetric`]` rustdoc link syntax where appropriate.

CRITICAL: Do NOT modify any `pub mod`, `pub use`, `#![allow(...)]`, or code logic. Only add `//!` doc comment lines.
  </action>
  <verify>
Run `cargo doc -p eink-dither --no-deps 2>&1` -- must succeed with no errors.
Run `cargo test --doc -p eink-dither 2>&1` -- must pass (existing doc examples still work).
Visually confirm in the source that the `# Color Science` section exists after `# Dithering Algorithms`.
  </verify>
  <done>
lib.rs contains a `# Color Science` section with: (1) three-color-space rationale table, (2) ASCII pipeline diagram, (3) HyAB + chroma coupling explanation clearly marking chroma coupling as domain-specific extension, (4) error-diffusion-in-LinearRgb rationale. `cargo doc` and `cargo test --doc` both pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add inline WHY comments at every color space conversion site</name>
  <files>
    crates/eink-dither/src/palette/palette.rs
    crates/eink-dither/src/dither/mod.rs
    crates/eink-dither/src/dither/blue_noise.rs
    crates/eink-dither/src/preprocess/preprocessor.rs
    crates/eink-dither/src/color/oklab.rs
    crates/eink-dither/src/color/linear_rgb.rs
    crates/eink-dither/src/color/srgb.rs
    crates/eink-dither/src/color/lut.rs
  </files>
  <action>
Add inline `// WHY ...` comments at every color space conversion site in IMPLEMENTATION (non-test) code. The research (03-RESEARCH.md, "Conversion Audit" section) lists every site with line numbers. Use those as a guide but verify actual line numbers in the current code.

Each comment must explain WHY that color space is used at that point, NOT repeat what the code does. The litmus test: "If I changed this to a different color space, what would go wrong?"

**palette/palette.rs** (Palette::new, around lines 185-201):
- Before the official Srgb->LinearRgb conversion: WHY explaining that error diffusion operates in linear space, so palette entries must be precomputed in LinearRgb.
- Before the official LinearRgb->Oklab conversion: WHY explaining that perceptual distance matching requires OKLab, so palette entries must be precomputed there too.
- Same pattern for the actual color conversions (they serve the same purposes for actual display colors vs official colors).
- Before the chroma precomputation: WHY explaining that chroma magnitudes are precomputed for the HyAB chroma coupling penalty, avoiding per-pixel sqrt.

These can be consolidated into a SINGLE multi-purpose comment before the block rather than 5 nearly-identical comments. Use the approach from 03-RESEARCH.md Example 5: one comment explaining WHY three representations per palette entry exist (sRGB for output, LinearRgb for error diffusion, OKLab for perceptual distance, chroma for coupling penalty). Place it before line 186 (`let official_srgb`).

**dither/mod.rs** (dither_with_kernel):
- Before `Srgb::from(pixel)` in find_exact_match (~line 202): WHY sRGB byte comparison for exact match detection (device palette entries are defined in sRGB; byte-exact comparison avoids floating-point rounding).
- Before `Oklab::from(pixel)` (~line 292): WHY OKLab for palette matching (perceptually uniform distances).
- Before/at the error computation (~lines 296-302): WHY LinearRgb for error (quantization error = physical light difference; light adds linearly).

**dither/blue_noise.rs** (BlueNoiseDither::dither):
- Before `Oklab::from(pixel)` (~line 136): WHY OKLab for palette matching (same rationale as error diffusion path).
- At chroma computation (~line 137): WHY chroma is computed here (needed for find_second_nearest's HyAB chroma coupling; not needed in error diffusion path because find_nearest computes it internally).

**preprocess/preprocessor.rs** (process and boost_saturation):
- Before `LinearRgb::from(pixel)` (~line 269): WHY LinearRgb as working space (all arithmetic -- contrast, saturation -- must operate on physically linear light values).
- Before the Oklab/Oklch chain in boost_saturation (~lines 308-316): WHY Oklch for saturation (polar form of OKLab where chroma is an independent axis; scaling chroma preserves hue exactly, unlike HSL/HSV).
- At the Oklch->Oklab->LinearRgb return path (~lines 315-316): WHY converting back (return to working space after perceptual adjustment).

**color/oklab.rs** (From impls):
- In `From<LinearRgb> for Oklab` (~line 135): The existing doc comment explains the math. Add a brief `// WHY` comment before Step 1 explaining: "OKLab provides perceptually uniform distances needed for palette matching. The M1 matrix maps from linear sRGB primaries to the LMS cone responses that OKLab is built on."
- In `From<Oklab> for LinearRgb` (~line 176): Add a brief `// WHY` before Step 1: "Inverse transform back to LinearRgb for error diffusion and pixel output. Result is intentionally unclamped -- out-of-gamut values are valid intermediate results during error diffusion."

**color/linear_rgb.rs** (From impl):
- In `From<Srgb> for LinearRgb` (~line 46): The existing doc comment is good. Add a `// WHY` inside the function body: "LUT-based gamma decode (IEC 61966-2-1). sRGB's gamma curve makes arithmetic incorrect; linear space is required for physically accurate color math (error diffusion, contrast adjustment, blending)."

**color/srgb.rs** (From impl):
- In `From<LinearRgb> for Srgb` (~line 105): The existing doc comment is good. Add a `// WHY` inside the function body: "LUT-based gamma encode for output/storage. Linear values must be re-encoded to sRGB for correct display on devices and for byte-exact palette matching."

**color/lut.rs**:
- Before `srgb_to_linear()` function (~line 14): Add a `// WHY LUT` comment explaining that the IEC 61966-2-1 transfer function involves a branch + power function that is expensive per-pixel. A 4096-entry LUT with linear interpolation achieves <0.01% error at a fraction of the cost, critical for per-pixel conversions in tight dither loops.
- Same rationale applies to `linear_to_srgb()` (~line 44) -- add a similar comment or a "see above" reference.

CRITICAL RULES:
- Do NOT modify any code logic. Only add or modify comments and doc strings.
- Do NOT add WHY comments to test code (functions inside `#[cfg(test)]` modules).
- Do NOT write comments that merely repeat what the code does (e.g., "convert to OKLab"). Every comment must answer "why THIS space HERE".
- Keep comments concise: 1-3 lines maximum per conversion site.
  </action>
  <verify>
Run `cargo test -p eink-dither 2>&1` -- all tests must pass (no logic changes).
Run `cargo clippy -p eink-dither 2>&1` -- no new warnings.
Grep for `// WHY` in the 8 files and confirm count matches the audit (~15+ sites).
  </verify>
  <done>
Every color space conversion in implementation (non-test) code across all 8 files has a `// WHY` comment explaining why that specific color space is used at that point. No code logic has changed. All tests pass. Clippy clean.
  </done>
</task>

<task type="auto">
  <name>Task 3: Final verification and commit</name>
  <files>crates/eink-dither/src/lib.rs</files>
  <action>
Run the full verification suite to confirm documentation is correct and complete:

1. `cargo test --doc -p eink-dither` -- doc examples compile and pass
2. `cargo test -p eink-dither` -- all unit and integration tests pass
3. `cargo doc -p eink-dither --no-deps` -- documentation builds without warnings
4. `cargo clippy -p eink-dither` -- no new warnings
5. Verify no code logic changes: `git diff --stat` should show only comment/doc additions (lines starting with `//` or `//!`), no changes to executable code

If any doc test fails, fix the doc example (likely an API that changed in Phase 1 or 2). Do NOT change code logic to fix a doc test.

Commit all changes with message: `docs(eink-dither): add color science rationale, pipeline diagram, and WHY comments`

Update CHANGES.md unreleased section with: "Added color science documentation to eink-dither crate (distance metric rationale, pipeline diagram, inline comments)"
  </action>
  <verify>
All four cargo commands pass with zero errors and zero new warnings.
Git log shows the commit.
CHANGES.md has the entry.
  </verify>
  <done>
All documentation changes are committed. cargo test, cargo doc, cargo clippy all pass. CHANGES.md updated.
  </done>
</task>

</tasks>

<verification>
Phase 3 is complete when all three requirements are met:

- **DOCS-01**: `cargo doc -p eink-dither --no-deps --open` shows a "Color Science" section in the crate-level docs with HyAB + chroma coupling rationale, clearly marking chroma coupling as domain-specific (not published literature).
- **DOCS-02**: The same crate-level docs contain an ASCII pipeline diagram showing color space at each stage.
- **DOCS-03**: Running `grep -rn "// WHY" crates/eink-dither/src/ --include="*.rs" | grep -v test` shows WHY comments at 15+ conversion sites across 8 implementation files.

No code logic has been modified. `cargo test -p eink-dither` passes identically to before this phase.
</verification>

<success_criteria>
1. lib.rs crate-level docs contain a "# Color Science" section with HyAB + chroma coupling rationale
2. lib.rs crate-level docs contain an ASCII pipeline diagram showing color spaces at each stage
3. Every color space conversion in implementation code has a WHY comment
4. Chroma coupling is explicitly documented as domain-specific extension (NOT standard HyAB)
5. cargo test, cargo doc, cargo clippy all pass with no new warnings
6. CHANGES.md updated
7. All changes committed
</success_criteria>

<output>
After completion, create `.planning/phases/03-color-science-documentation/03-01-SUMMARY.md`
</output>
